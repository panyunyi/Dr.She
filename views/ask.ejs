<!DOCTYPE html>
<html class="no-js drshe_wap" style="font-size: 37.5px;">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta name="description" content="">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">

    <title>快问医生</title>

    <link rel="shortcut icon" href="http://media2.chunyuyisheng.com/@/static/favicon.ico">

    <link rel="stylesheet" href="../stylesheets/cy1.css">
    <link rel="stylesheet" href="../stylesheets/ask.css">

    <style>
        .age {
            margin-top: .26667rem;
            margin-right: .21rem;
        }

        .toolbar {
            height: 0
        }

        .ask-description p {
            font-size: .42667rem;
            margin-bottom: .2rem;
        }

        .ask-description textarea {
            border-bottom: 2px solid #eee !important;
        }

        .age {
            font-size: .42667rem;
            border-bottom: 2px solid #eee !important;
            padding-bottom: .4rem;
            width: 100%;
        }
        .img-list p {
            font-size: .42667rem;
            margin-bottom: .2rem;
        }
    </style>
</head>

<body class="">

    <div id="html1" class="partner-right">
        <%if (hasheader){%>
            <header>
                <div class="block-left">
                    <a href="http://weixin.chunyuyisheng.com/cooperation/wap/doctor/identified_info_page/?doctor_id=<%=doctor_id%>&partner=chunyu_wap">
            <img src="<%=image%>" class="doctor-avatar-small">
        </a>
                </div>
                <div class="block-right">
                    <h6 class="doctor-title-small">
                        <%=name%><span><%=hospital%></span></h6>
                    <span class="doctor-label"><%=clinic%></span><span class="doctor-label"><%=title%></span>
                </div>
            </header>
            <%}%>

                <section class="ask-description">
                    <p>描述体症：</p>
                    <textarea autofocus="" id="description" placeholder="便于医生做出准确分析，字数限制为10~300字"></textarea>
                    <p class="age">请填写年龄：<input style="width: 16%;height:22px;border: 0px;font-size: .42667rem;margin-bottom: .06rem;" type="number"
                            id="age" name="age" min="18" max="60" placeholder="年龄" /></p>
                </section>

                <div class="img-list">
                    <div class="line" style="position: relative;">
                        <p>添加照片：</p>
                        <button class="img-container select" id="add-img">
                    <input style="font-size: 999px; opacity: 0; position: absolute; top: 0px; left: 0px; width: 100%; height: 100%;" type="file" name="iconImage" id="Image" accept="image/jpeg,image/png,image/gif,image/bmp">
                </button>
                    </div>

                </div>
                <div class="toolbar">

                    <button id="ask" class="btn" onclick="getNum(description.value)">提交</button>
                    <p class="notice" style="float:left;margin-left:.5rem;text-decoration:underline">如何采集图像</p>
                    <p class="notice">(本服务由三甲、专科医生提供)</p>
                </div>
    </div>

    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/1.1.0/weui.min.css">
    <script type="text/javascript" src="../weui.js"></script>
    <script type="text/javascript">
        var sum = 0;

        var points = <%=points%>;

        $('#Image').change(function (event) {
            console.log(1);
            if ($(".img-list img").length == 3) {
                weui.alert('只能上传3张图片');
                return;
            }
            /* Act on the event */
            if ($('#Image').val().length) {
                var fileName = $('#Image').val();
                var extension = fileName.substring(fileName.lastIndexOf('.'), fileName.length).toLowerCase();
                if (extension == ".jpg" || extension == ".png") {
                    var data = new FormData();
                    data.append('iconImage', $('#Image')[0].files[0]);
                    var loading = weui.loading('正在上传图片...', {
                        className: 'custom-classname'
                    });
                    $.ajax({
                        url: '/ask/upload',
                        type: 'POST',
                        data: data,
                        cache: false,
                        contentType: false, //不可缺参数
                        processData: false, //不可缺参数
                        success: function (data) {
                            loading.hide();
                            sum++;
                            if (sum == 3) {
                                return;
                            } else {
                                $('#add-img').before('<div class="img-container"><img src="' + data.img + '"><span class="del"></span></div>');
                            }
                        },
                        error: function () {
                            console.log('error');
                        }
                    });
                }
            }
        });
        $(".img-list").on("click", ".del", function () {
            var e = $(this);
            weui.dialog({
                title: '',
                content: '删除该图片？',
                className: 'custom-classname',
                buttons: [{
                    label: '取消',
                    type: 'default',
                    onClick: function () { }
                }, {
                    label: '确定',
                    type: 'primary',
                    onClick: function () { sum--; e.parents(".img-container").remove(); }
                }]
            });
        });
        $('.service-level-btn').on("click", function () {
            if ($('.service-level-btn').is('.select')) {
                $('.service-level-btn.select').removeClass('select');
            } else {
                $('.service-level-btn').addClass('select');
            }

        });

        function getNum(str) {
            if ($("#age").val().length < 1) {
                weui.alert('请输入年龄');
                return;
            }
            if (str.length >= 10 && str.length <= 1000) {
                var imglist = '';
                $(".img-list img").each(function (i) {
                    imglist += $(this).attr("src") + ",";
                });

                var num = 2;

                if (points < num) {
                    window.location.replace("pay?points=" + num);
                    return;
                }
                if (<%=hasheader %>){
                    var point = <%=price%>/500;
                    if (point <= 5) {
                        num = 5
                    } else if (point > 5 && point <= 10) {
                        num = 10
                    } else if (point > 10) {
                        num = 20
                    }
                    $.post("/ask/add/pay", { content: $("#description").val(), age: $("#age").val(), imglist: imglist, num: num, price: <%=price%> ,doctor_id: "<%=doctor_id%>" }, function (result) {
                        if (result.id != 0) {
                            window.location.replace("inquiry?id=" + result.id);
                        } else {
                            weui.alert("创建问题失败，请联系客服。")
                        }
                    });
                }else{
                    $.post("/ask/add/free", { content: $("#description").val(), age: $("#age").val(), imglist: imglist, num: num }, function (result) {
                        if (result.id != 0) {
                            window.location.replace("inquiry?id=" + result.id);
                        } else {
                            weui.alert("创建问题失败，请联系客服。")
                        }
                    });
                }
            } else {
                weui.alert('字数限制为10~1000');
            }
        }
    </script>
</body>

</html>